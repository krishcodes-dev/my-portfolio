"use client";

import React, { useEffect, useRef, useState } from "react";
import { motion, useAnimation, AnimatePresence } from "framer-motion";
import gsap from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";
import { orbitTechData, OrbitTechItem } from "@/lib/orbitTech";
import { iconMap } from "@/lib/techIcons";
import { useScrollStore } from "@/lib/store";

export default function OrbitalSystem() {
    const containerRef = useRef<HTMLDivElement>(null);
    const orbitRef = useRef<HTMLDivElement>(null);

    const [isMobile, setIsMobile] = useState(false);

    // Read global hover state
    const hoveredTechId = useScrollStore((state) => state.hoveredTechId);
    const scrollProgress = useScrollStore((state) => state.scrollProgress);

    // Check for mobile
    useEffect(() => {
        const checkMobile = () => {
            setIsMobile(window.matchMedia("(hover: none) and (pointer: coarse)").matches || window.innerWidth < 768);
        };
        checkMobile();
        window.addEventListener("resize", checkMobile);
        return () => window.removeEventListener("resize", checkMobile);
    }, []);

    // Initial Setup & ScrollTrigger Logic
    useEffect(() => {
        if (isMobile) return;

        gsap.registerPlugin(ScrollTrigger);

        const container = containerRef.current;
        const orbit = orbitRef.current;
        if (!container || !orbit) return;

        // Radius State for Animation
        const state = { radius: 250 }; // Initial radius
        const total = orbitTechData.length;
        const orbitNodes = gsap.utils.toArray<HTMLElement>(".orbit-node");
        const gridContainer = document.querySelector(".grid-container");
        const gridNodes = gsap.utils.toArray<HTMLElement>(".grid-node");

        // Function to update orbital positions
        const updatePositions = () => {
            orbitNodes.forEach((node, i) => {
                const angle = (i / total) * Math.PI * 2;
                gsap.set(node, {
                    x: Math.cos(angle) * state.radius,
                    y: Math.sin(angle) * state.radius
                });
            });
        };

        // Initial Position
        updatePositions();

        const timeline = gsap.timeline({
            scrollTrigger: {
                trigger: container,
                start: "top bottom", // Start when top of container hits bottom of viewport
                end: "center center", // End when center of container hits center of viewport
                scrub: true,
                onUpdate: (self) => {
                    useScrollStore.getState().setScrollProgress(self.progress);
                }
            }
        });

        // --- PHASE 1: CONSTRICT ORBIT ---
        // 1. Shrink radius
        // 2. Fade out core
        timeline.addLabel("start");

        timeline.to(state, {
            radius: 100,
            duration: 2,
            ease: "power2.inOut",
            onUpdate: updatePositions
        }, "start");



        // Removed Phase 2 & 3 (Grid Reveal) as we are purely 3D now.


        return () => {
            ScrollTrigger.getAll().forEach(t => t.kill());
        };
    }, [isMobile]);

    if (isMobile) {
        // Mobile Fallback (Simple List)
        return (
            <section id="tech-stack" className="py-20 px-6">
                <h2 className="text-3xl font-bold mb-8 text-center">Technologies</h2>
                <div className="flex flex-wrap gap-4 justify-center">
                    {orbitTechData.map((tech) => {
                        const Icon = iconMap[tech.id] as React.ComponentType<{ size?: number; style?: React.CSSProperties }>;
                        return (
                            <div
                                key={tech.id}
                                className="flex items-center gap-2 px-4 py-2 rounded-full text-sm"
                                style={{
                                    backgroundColor: 'rgba(0, 0, 0, 0.3)',
                                    border: `1px solid ${tech.color}`,
                                }}
                            >
                                {Icon && <Icon size={16} style={{ color: tech.color }} />}
                                <span style={{ color: '#ffffff' }}>{tech.name}</span>
                            </div>
                        );
                    })}
                    \u003c/div\u003e
            \u003c/section>\u003c/antml:parameter>
                    <parameter name="StartLine">118
                        );
    }

                        return (
                        <section id="tech-stack" ref={containerRef} className="h-[400vh] relative overflow-hidden pointer-events-none">
                            {/* Scroll Target for Interaction (approx 0.8 progress) */}
                            <div id="tech-stack-target" className="absolute top-[25%] left-0 w-full h-px pointer-events-none opacity-0" />

                            {/* Sticky Container - ensure it doesn't block clicks to canvas */}
                            <div className="sticky top-0 h-screen w-full flex items-center justify-center overflow-hidden pointer-events-none">

                                {/* --- 1. ORBIT CONTAINER (Now 3D Managed) --- */}

                                {/* --- 1. ORBIT CONTAINER (Now 3D Managed) --- */}
                                <div ref={orbitRef} className="absolute z-10 w-[600px] h-[600px] pointer-events-none" />

                            </div>
                        </section>


                        );
}
